@page "/table/edit/{Id:int}"
@attribute [Authorize]
@rendermode InteractiveServer
@inject NavigationManager navigationManager
@inject IWebHostEnvironment Env
@inject IConfiguration configuaration
@inject IJSRuntime JsRuntime
@inject IApiService ApiService
@inject IHttpContextAccessor HttpContextAcessor
@inject UserManager<ApplicationUser> UserManager

<h3>Editar Mesa</h3>

<EditForm OnValidSubmit="OnSubmit" Model="@Model" FormName="editTable">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="mb-3">
        <label class="form-label">Identificação:</label>
        <InputText @bind-Value="Model.Identification" class="form-control" />
    </div>
    <div class="mb-3">
        <label class="form-label">QRCode:</label>
        <InputText @bind-Value="Model.QRLink" class="form-control" />
    </div>
    <button type="submit" class="btn btn-primary">Enviar</button>
</EditForm>

@code {
    private TableDTO Model { get; set; } = new TableDTO();
    [Parameter]
    public int Id { get; set; }
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    ClaimsPrincipal CurrentUser;
    private ApplicationUser user = default!;
    private int _companyId;

    protected override async Task OnInitializedAsync()
    {
        CurrentUser = (await authenticationStateTask).User;
        if (CurrentUser.Identity.IsAuthenticated)
        {
            user = await UserManager.GetUserAsync(CurrentUser);
            _companyId = user.CompanyId;
        }
        var url = configuaration["ApiLinks:TableGetById"];
        Dictionary<string, object> parameters = new Dictionary<string, object>();
        parameters.Add("tableId", Id);
        parameters.Add("companyId", _companyId);
        GenericCommandResult commandResult = await ApiService.GetWithParameters<TableDTO>(url, HttpContextAcessor.HttpContext.Request.Cookies["Token"].ToString(), parameters);
        if (commandResult.Sucess && commandResult.Data is TableDTO)
        {
            Model = (TableDTO)commandResult.Data;
        }
        else
            await JsRuntime.InvokeVoidAsync("Alert", "Mesa não encontrada!");
    }

    private async void OnSubmit()
    {
        var url = configuaration["ApiLinks:TableUpdate"];
        GenericCommandResult commandResult = await ApiService.PutAsJsonAsync<TableDTO>(url, HttpContextAcessor.HttpContext.Request.Cookies["Token"].ToString(), Model);
        if (commandResult.Sucess)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Mesa alterada!");
            navigationManager.NavigateTo(configuaration["ApplicationLinks:TableManager"]);
        }
        else
            await JsRuntime.InvokeVoidAsync("alert", "Mesa não alterada!");
    }
}

